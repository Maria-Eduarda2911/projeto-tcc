<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Mapa de Alagamentos - Recife</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    body { margin:0; font-family:sans-serif; background:#0f172a; color:#eee; }
    #map { height: 80vh; }
    .panel { padding:10px; background:#111827; }
    label { display:block; margin-top:6px; font-size:13px; }
    input { width:100%; padding:6px; margin-top:2px; background:#1f2937; border:1px solid #374151; color:#eee; border-radius:4px; }
    button { margin-top:10px; padding:8px 12px; background:#2563eb; border:none; border-radius:4px; color:#fff; cursor:pointer; }
    button:hover { background:#1d4ed8; }
  </style>
</head>
<body>
  <h2 style="padding:10px; margin:0;">Previsão de Alagamentos - Recife</h2>
  <div id="map"></div>

  <div class="panel">
    <h3>Simulação</h3>
    <label>Nome <input id="nome" value="Simulação Boa Viagem"></label>
    <label>Latitude <input id="lat" type="number" step="0.0001" value="-8.12"></label>
    <label>Longitude <input id="lon" type="number" step="0.0001" value="-34.9"></label>
    <label>Chuva (mm) <input id="chuva" type="number" value="65"></label>
    <label>Prob. Chuva (%) <input id="prob" type="number" value="80"></label>
    <label>Acumulado 24h (mm) <input id="acum" type="number" value="100"></label>
    <button onclick="simular()">Simular e adicionar no mapa</button>
    <div id="msg"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const API = "http://127.0.0.1:8000";
    const map = L.map("map").setView([-8.06, -34.9], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    const markers = L.layerGroup().addTo(map);

    function cor(cor, score){
      if(cor==="vermelho") return "#ef4444";
      if(cor==="laranja") return "#f59e0b";
      if(cor==="verde") return "#10b981";
      if(score>=0.7) return "#ef4444";
      if(score>=0.4) return "#f59e0b";
      return "#10b981";
    }

    async function carregarMapa(){
      markers.clearLayers();
      const res = await fetch(API+"/mapa");
      const data = await res.json();
      data.pontos.forEach(p=>{
        L.circleMarker([p.latitude,p.longitude],{
          radius:6+(p.score*6),
          fillColor:cor(p.cor,p.score),
          color:"#000", weight:1, fillOpacity:0.9
        }).bindPopup(`<b>${p.nome}</b><br>Risco: ${p.risco}<br>Score: ${p.score}`).addTo(markers);
      });
    }

    async function simular(){
      const payload = {
        nome: document.getElementById("nome").value,
        latitude: parseFloat(document.getElementById("lat").value),
        longitude: parseFloat(document.getElementById("lon").value),
        chuva_mm: parseFloat(document.getElementById("chuva").value),
        prob_chuva: parseFloat(document.getElementById("prob").value),
        acumulado_24h: parseFloat(document.getElementById("acum").value)
      };
      const res = await fetch(API+"/simular",{
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const p = await res.json();
      L.circleMarker([p.latitude,p.longitude],{
        radius:6+(p.score*6),
        fillColor:cor(p.cor,p.score),
        color:"#2563eb", weight:2, fillOpacity:0.9
      }).bindPopup(`<b>${p.nome}</b><br>Risco: ${p.risco}<br>Score: ${p.score}`).addTo(markers);
      document.getElementById("msg").innerHTML = `<p style="color:#10b981">Simulação adicionada: risco ${p.risco}, score ${p.score}</p>`;
    }

    carregarMapa();
  </script>
</body>
</html>
